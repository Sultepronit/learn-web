<!DOCTYPE html>
<html>
<head>
	<title>EngDic</title>
	<meta charset="utf-8">
	
<style>
* {	
	font-size: 100%;
	/*margin: 0.1em;*/
	margin: 0;
}

body {
	font-size: 1.5em;
	margin: 1%;
}

header {
	position: fixed;
	top: 0;
	padding: 0.1em;
	width: 97%;
	background-color: white;
	display: flex;
}

input {
	/*position: fixed;
	top: 0.1em;*/
	/*float: right;*/
	font-size: 1.5em;
	max-width: 88%;
	/*width: -webkit-fill-available;*/
}

.play {
	/*float: left;*/
	width: 1.5em;
	height: 1.5em;
	margin: 0.3em;
	/*margin-top: 0.2em;*/
}

main {
	margin-top: 2.6em;
}

a.orig {
	float: right;
	color: green;
}

.found {
	color: red;
	text-decoration: underline;
	cursor: pointer;
}

._2xKEq {
	/*margin-block-start: 0;*/
	/*padding-inline-start: 1em;*/
	list-style: upper-roman;
}
	
._24CCn {
	color: gray;
	font-style: italic;
}

.dir-aware-text-right {
	text-align: right;
}

.icon-dots-vertical {
	display: none;
}	
.py-2 {
	padding: 1%;
	padding-bottom: 0;
	border-top: solid black 2px;
	font-style: italic;
}

.dir-aware-pr-1 {
	/*color: blue;*/
	/*border-bottom: dotted blue 2px;*/
	width: fit-content;
	background-color: #cdfbf0;
}
.truncate {
	color: gray;
	font-size: 0.7em;
	/*float: right;*/
	margin-top: -0.3em;
}
</style>

</head>

<body>
	<header>
		<button class="play"></button>
		<input>
	</header>
	
	<main>
		<h2 class="found">-</h2>
		<div class="lingvo">
			<p>lingvo article</p>
		</div>
		
		<!-- <hr> -->

		<div class="images">images</div>
		
		<a class="orig" href="glosbe-orig" target="_blank">glosbe</a>
		<div class="glosbe">
			<p>glosbe article</p>
		</div>
	</main>

<script src="html-parser.js"></script>
<script>
"use strict";
const input = document.querySelector('input');
const found = document.querySelector('.found');
const lingvo = document.querySelector('.lingvo');
const images = document.querySelector('.images');
const glosbe = document.querySelector('.glosbe')
//input.select();
console.log(input);

let history = JSON.parse(localStorage.getItem('history')) || [];

const handleLingvo = async (encoded) => {
	const urlLingvo = 'http://localhost:8901/?dic=lingvo&word=';
	//const urlLingvo = 'https://dic0.onrender.com/?dic=lingvo&word=';
	const resp = await fetch(urlLingvo + encoded);
	console.log(resp);
	const obj = await resp.json();
	console.log(obj);
	/* const lingvoArticleHTML = obj.article;
	if(obj.foundWord) found.textContent = obj.foundWord;
	lingvo.innerHTML = lingvoArticleHTML; */
	const parsedPage = parseHTML(obj.page);
	const article = getBlock(parsedPage, 'div', 'class="_1mexQ');
	console.log(article);

	const h1 = getBlock(article, 'h1');
	console.log(h1);
	const h1st = getTextContent(h1);
	console.log('h1', h1st);
	found.textContent = h1st;

	const paragraphs = getBlock(article, 'p', null, true, 'ol');
	console.log(paragraphs);

	let results = '';
	for(let p of paragraphs) {
		const cont = getTextContent(p);
		console.log('p', cont);
		if(cont) results += '<p>' + cont + '</p>';
	}

	const list = getBlock(article, 'ol');
	results += stringifyTags(list);

	const trs = getBlock(parsedPage, 'tr', null, true);
	//console.log('trs', trs);
	const verbForms = [];
	for(let tr of trs) {
		const cont = getTextContent(tr, ' ');
		if(cont.includes('Imperative')) { // verb 1
			verbForms[0] = cont.split('Imperative ')[1];
			continue;
		}
		if(cont.includes('Past') && !verbForms[1]) { // verb 2
			verbForms[1] = cont.split('Past ')[1];
			continue;
		}
		if(cont.includes('(Participle II) ')) { // verb 3
			verbForms[2] = cont.split('(Participle II) ')[1];
			continue;
		}
		if(cont.includes('Common case')) { // noun
			const tds = getBlock(tr, 'td', null, true);
			results += `<p>n: ${getTextContent(tds[1])} / ${getTextContent(tds[2])} </p>`;
		}
	}
	if(verbForms.length > 0) {
		results += `<p>v: ${verbForms[0]} / ${verbForms[1]} / ${verbForms[2]} </p>`;
	}
	console.log(verbForms);

	//console.log(results);
	lingvo.innerHTML = results;
}

const handleGlosbe = async (encoded) => {
	//const urlGlosbe = 'http://localhost:8900/?dic=glosbe&word=';
	const urlGlosbe = 'https://dic0.onrender.com/?dic=glosbe&word=';
	const resp = await fetch(urlGlosbe + encoded);
	console.log(resp);
	const obj = await resp.json();
	if(obj.examples) glosbe.innerHTML = obj.examples;
	if(obj.images) images.innerHTML = obj.images;
	//console.log(glosbe.innerHTML);
}

const newRequest = async () => {
	const inputted = input.value
	if(!inputted) return;

	input.select();
	found.textContent = '';
	lingvo.innerHTML = '';
	images.innerHTML = '';
	glosbe.innerHTML = '';
	console.log(inputted);
	
	if(history[history.length - 1] !== inputted) {
		history.push(inputted);
		localStorage.setItem('history', JSON.stringify(history));
	}
	
	const encoded = encodeURIComponent(inputted);
	console.log(encoded);

	handleLingvo(encoded);
	handleGlosbe(encoded);
}
input.onkeyup = e => {if(e.key === 'Enter') newRequest()};

if(history.length > 0) {
	input.value = history[history.length - 1];
	newRequest();
}

found.onclick = () => {
	input.value = found.textContent;
	newRequest();
}

let timer = 0;
setInterval(() => {
	timer++;
	console.log(timer);
	if(timer === 15) {
		timer = 0;
		//fetch('https://dic0.onrender.com/?dic=lingvo&word=input');
	}
	
}, 1 * 60 * 1000);

</script>
</body>
</html>
